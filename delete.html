<script runat="server">
    Platform.Load("Core", "1");
    Write("script start ");
    //AUTHENTICATE
    var url = "https://mc5x5rqks68-f67k0fy4h7dd59w1.auth.marketingcloudapis.com/v2/token";
    var contentType = "application/json";
    var payload =
        '{"grant_type": "client_credentials","client_id": "p4c41opzwyv0nznn7ekqarpv","client_secret": "JMhHUpJ50qReHg7TyWykxfUu"}';

    var accessTokenResult = HTTP.Post(url, contentType, payload);
    var accessToken = Platform.Function.ParseJSON(accessTokenResult["Response"][0]).access_token;

    if (accessToken != "") {
        //EXECUTE
        Write("token success ");
        try {
            var autoGeneratedFormDE = DataExtension.Init("90960E6C-F844-4FC7-BCA2-48D53ADD2A5F");
            var rows = autoGeneratedFormDE.Rows.Lookup(["isProcessed"], ["false"]);


            var subKeysString = "";


            for (var i = 0; i < rows.length; i++) {
                subKeysString += '"' + rows[i].subscriberkey + '"';
                if (i != rows.length - 1) {

                    subKeysString += ',';
                }

            }


            var deleteUrl =
                "https://mc5x5rqks68-f67k0fy4h7dd59w1.rest.marketingcloudapis.com/contacts/v1/contacts/actions/delete?type=keys";
            var payload1 =
                '{"deleteOperationType": "ContactAndAttributes","values": [' + subKeysString + ' ]}';


            var headerNames = ["Authorization"];
            var s1 = "Bearer ";
            var headerValues = [s1.concat(accessToken)];
            var result = HTTP.Post(deleteUrl, contentType, payload1, headerNames, headerValues);
            var parsedResult = Stringify(Platform.Function.ParseJSON(result.Response[0]));



            if (result.StatusCode == 200) {
                Write("code                 " + Stringify(result.StatusCode));

                for (var i = 0; i < rows.length; i++) {

                    Write(Stringify(rows[i]) + " / ");
                    var id = Stringify()
                    Write(id + " / ");

                    var updatedRowCount = Platform.Function.UpsertData(
                        'autoGeneratedForm',
                        ['Id'], [rows[i].Id],
                        ['reason'], ['john.smith@mail.com']

                    );
                    // var rowsAffected = autoGeneratedFormDE.Rows.Update({ reason: 'test' }, ['Id'], [id]);
                    Write(Stringify(updatedRowCount) + " / ");
                }

            }


            Platform.Function.InsertData("mmApiDeleteResponse", ["code"], [parsedResult]);

        } catch (ex) {
            Write("Exception Error: " + Stringify(ex));
        }
    }
</script>